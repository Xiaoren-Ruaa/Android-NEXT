name: Build ARM64 Initramfs with BusyBox

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      INITRAMFS_DIR: ${{ github.workspace }}/initramfs
      OUTPUT_DIR: ${{ github.workspace }}/output

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cpio gzip wget

    - name: Prepare initramfs directories
      run: |
        mkdir -p $INITRAMFS_DIR/{bin,proc,sys,dev,tmp,newroot}
        mkdir -p $OUTPUT_DIR

    - name: Download official ARM64 BusyBox binary
      run: |
        cd $INITRAMFS_DIR/bin
        wget -O busybox https://busybox.net/downloads/binaries/1.36.1-defconfig-multiarch/busybox-arm64
        chmod +x busybox
        ln -sf busybox sh

    - name: Add init script
      run: |
        # 假设你的 init 脚本已经放在仓库根目录
        cp $GITHUB_WORKSPACE/init $INITRAMFS_DIR/
        chmod +x $INITRAMFS_DIR/init

    - name: Build initramfs.cpio.gz
      run: |
        cd $INITRAMFS_DIR
        find . | cpio -o -H newc | gzip > $OUTPUT_DIR/initramfs.cpio.gz

    - name: Verify initramfs contents
      run: |
        gzip -d -c $OUTPUT_DIR/initramfs.cpio.gz | cpio -t | grep -E "init|sh|busybox"

    - name: List output files
      run: ls -lh $OUTPUT_DIR
