name: Build QEMU ARM64 (Meson)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-arm64-qemu:
    runs-on: ubuntu-latest

    env:
      PREFIX: ${{ github.workspace }}/qemu-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git python3 python3-pip \
          ninja-build meson pkg-config \
          libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \
          libaio-dev gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Clone QEMU source
      run: git clone --depth 1 https://github.com/qemu/qemu.git qemu-src

    - name: Configure Meson build
      run: |
        mkdir -p qemu-src/build
        cd qemu-src/build
        meson setup --cross-file ../aarch64-cross.txt \
          --prefix=${PREFIX} \
          -Dtargets=aarch64-softmmu \
          -Dvirtfs=enabled \
          -Dsystem=true \
          -Dlinux-user=false \
          --buildtype=release .

    - name: Compile with Ninja
      run: |
        cd qemu-src/build
        ninja -j$(nproc)
        ninja install

    - name: Check binary
      run: |
        file ${{ env.PREFIX }}/bin/qemu-system-aarch64
        ls -lh ${{ env.PREFIX }}/bin

    - name: Upload ARM64 binary
      uses: actions/upload-artifact@v4
      with:
        name: qemu-system-arm64
        path: ${{ env.PREFIX }}/bin/qemu-system-aarch64
