name: Build QEMU ARM64 Native

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    env:
      PREFIX: ${{ github.workspace }}/qemu-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git python3 python3-pip \
          ninja-build pkg-config \
          libglib2.0-dev libfdt-dev libpixman-1-dev \
          zlib1g-dev libaio-dev

        pip3 install --upgrade meson

    - name: Clone QEMU
      run: git clone --depth 1 https://github.com/qemu/qemu.git qemu-src

    - name: Configure
      run: |
        mkdir build
        cd build

        meson setup ../qemu-src \
          --prefix=${PREFIX} \
          -Dtargets=aarch64-softmmu \
          -Dvirtfs=enabled \
          -Dsystem=true \
          -Dlinux-user=false \
          --buildtype=release

    - name: Compile
      run: |
        cd build
        ninja -j$(nproc)
        ninja install

    - name: Verify
      run: |
        file ${{ env.PREFIX }}/bin/qemu-system-aarch64
        ls -lh ${{ env.PREFIX }}/bin

    - uses: actions/upload-artifact@v4
      with:
        name: qemu-system-aarch64
        path: ${{ env.PREFIX }}/bin/qemu-system-aarch64
